## 프로세스 동기화
* `프로세스 동기화`란 **프로세스 사이에 동기화를 하는 것**을 말한다. 현재는 대부분 쓰레드 기준으로 문맥 교환이 일어나기 때문에 *쓰레드 동기화*라고도 불린다.
* 프로세스 동기화는 `여러 프로세스가 공유하는 자원의 일관성을 유지`하는 것이다. 즉, **동기화**는 `공유 자원의 일관성을 유지`하는 것으로 볼 수 있다.
* 프로세스 동기화에 대한 시작은 **경쟁 상태** (Race Condition)과 **임계구역**(Critical Section)에 대한 이해부터 시작된다.

## 경쟁 상태 (Race Condition)
경쟁 상태란(Race Condition)이란 `공유 자원에 대해 여러 프로세스가 동시에 접근할 때 결과값에 영향을 줄 수 있는 상태`를 의미한다.  

* **동시에 여러 개의** 프로세스 혹은 쓰레드가 동일한 자료를 접근하여 조작하고, 그 실행 결과가 **접근이 발생한 특정 순서에 의존**하는 상황을 말한다.
* 경쟁 상태가 발생되면, 프로세스와 스레드에서 배웠던 `동시성 이슈`가 발생할 수 있다.
* 이런 경쟁 상태를 해결하기 위하여 `동기화(Synchronization)`이 필요한 것이다.

### Race Condition이 발생하는 경우

1. **커널 작업을 수행하는 중에 인터럽트 발생**
    커널 모드에서 데이터를 로드하여 작업을 수행하다가 `인터럽트가 발생`하여 같은 데이터를 조작하는 경우 발생할 수 있다.

    커널이 가진 **전역변수**는 모든 프로세스의 공유물이므로 경쟁상태의 가능성이 있다.
    
    * **해결법**: 커널모드에서 작업을 수행하는 동안, 인터럽트를 disable 시켜 CPU 제어권을 가져가지 못하도록 한다.

2. **프로세스가 'System Call'을 하여 커널 모드로 진입해 작업을 수행하는 도중 문맥 교환이 발생할 때**
    프로세스1이 `커널모드`에서 데이터를 조작하는 도중, **시간이 초과**되어 CPU 제어권이 프로세스2로 넘어가 같은 데이터를 조작하는 경우를 말한다.
    
    * **해결법**: 프로세스가 커널모드에서 작업을 하는 경우 시간이 초과되어도 CPU 제어권이 다른 프로세스에게 넘어가지 않도록 함

3. **멀티 프로세서에서 공유 메모리 내의 커널 데이터에 접근할 경우**
    멀티프로세스 환경에서 2개의 CPU가 동시에 커널 내부의 공유 데이터에 접근해 조작하는 경우에 발생할 수 있다.
    * **해결법**: 커널 내부에 있는 각 공유 데이터에 접근할 때마다 그 데이터에 대해 lock/unlock 함으로써 해결할 수 있다.

### 데이터베이스에서의 경쟁 상태
데이터베이스를 사용하는 경우에도 경쟁 상태라는 개념이 존재한다.

예를 들어, 다음과 같은 쿼리가 있다고 가정하자.

```
-- 현재 PK 의 최댓값에 1을 더해 새로운 PK 로 사용 
SELECT MAX(PK) + 1 AS NEXT_PK FROM USER;
```

* 이러한 방식은 두 개의 클라이언트가 동시에 쿼리를 실행할 수 있어 안전하지 않다.
* 두 클라이언트가 **같은 값을 사용하게 될 수도 있기 때문**이다. 이런 것을 경쟁 상태(race condtion)이라고 한다.
* 해당 문제는 시퀀스를 사용해서 해결할 수 있다.

### 경쟁상태 해결 방법
> 경쟁 상태는 메모리를 공유하기 때문에 발생한다. 따라서 **동기화**를 통해서 해결할 수 있다.

* 쓰레드의 순차적 실행(동기화)를 보장한다면, 경쟁상태가 발생하지 않게 할 수 있다.

예를 들어서, 탈의실에서 옷을 갈아입을때 다음과 같은 규칙이 존재한다.
> 탈의실에는 오직 한 명만 들어갈 수 있다.

위와 같은 규칙을 어긴 사람은 없을 것이다.

여기서 단어만 조금 바꿔서 동기화에서 **탈의실**을 `임계구역 (critical section)`이라고 하고, **오직 한 명만 들어갈 수 있는 것**을 `상호 배제(mutually exclusive)`라고 한다.


## 참고 자료
* https://github.com/NKLCWDT/cs/blob/main/Operating%20System/%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4%20%EB%8F%99%EA%B8%B0%ED%99%94.md
* https://github.com/gyoogle/tech-interview-for-developer/blob/master/Computer%20Science/Operating%20System/Race%20Condition.md
* https://velog.io/@klloo/%EC%9A%B4%EC%98%81%EC%B2%B4%EC%A0%9C-%EA%B2%BD%EC%9F%81-%EC%83%81%ED%83%9C-Race-Condition
* https://charles098.tistory.com/88